<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Test - Notifications Service</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 8px;
      }
      input,
      button {
        margin: 10px 0;
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .connected {
        background: #d4edda;
        color: #155724;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .error-box {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid #dc3545;
      }
      .notifications {
        border: 1px solid #ddd;
        padding: 10px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
        background: #f9f9f9;
      }
      .notification {
        padding: 10px;
        margin: 5px 0;
        background: white;
        border-left: 4px solid #007bff;
        border-radius: 4px;
      }
      .notification.unread {
        border-left-color: #28a745;
        font-weight: bold;
      }
      .notification.error {
        border-left-color: #dc3545;
        background: #fff5f5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîå WebSocket Test - Notifications Service</h1>

      <div>
        <label for="token">JWT Access Token:</label>
        <input
          type="text"
          id="token"
          placeholder="Paste your access token here"
        />
      </div>

      <button id="connectBtn" onclick="connect()">Connect</button>
      <button id="disconnectBtn" onclick="disconnect()" disabled>
        Disconnect
      </button>
      <button id="pingBtn" onclick="sendPing()" disabled>Send Ping</button>
      <button onclick="getNewToken()" style="background: #28a745">
        Get New Token
      </button>

      <div id="status" class="status disconnected">Status: Disconnected</div>

      <div id="errorBox" style="display: none" class="error-box"></div>

      <div class="notifications">
        <h3>Notifications:</h3>
        <div id="notificationsList"></div>
      </div>
    </div>

    <script>
      let socket = null

      function connect() {
        const token = document.getElementById('token').value.trim()

        if (!token) {
          alert('Please enter a JWT token')
          return
        }

        hideError()

        socket = io('ws://localhost:3004/notifications', {
          auth: {
            token: token,
          },
        })

        socket.on('connect', () => {
          console.log('Connected to WebSocket')
          updateStatus('Connected', true)
        })

        socket.on('connected', (data) => {
          console.log('Server confirmed connection:', data)
          addNotification(
            'System',
            `Connected to notifications service. User ID: ${data.userId}`,
            true,
          )
        })

        socket.on('notification', (data) => {
          console.log('Notification received:', data)
          addNotification(data.type, data.message, false, data.createdAt)
        })

        socket.on('error', (error) => {
          console.error('WebSocket error:', error)
          showError(error.message || 'Unknown error')
          addNotification(
            'Error',
            error.message || 'Unknown error',
            false,
            null,
            true,
          )
        })

        socket.on('disconnect', () => {
          console.log('Disconnected from WebSocket')
          updateStatus('Disconnected', false)
        })

        socket.on('connect_error', (error) => {
          console.error('Connection error:', error)
          showError('Failed to connect: ' + error.message)
          updateStatus('Connection Failed', false)
        })
      }

      function disconnect() {
        if (socket) {
          socket.disconnect()
          socket = null
        }
      }

      function sendPing() {
        if (socket && socket.connected) {
          socket.emit('ping')
          console.log('Ping sent')
        }
      }

      function getNewToken() {
        const email = prompt('Enter email:', 'user@example.com')
        const password = prompt('Enter password:', 'Password123!')

        if (!email || !password) return

        fetch('http://localhost:3001/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.accessToken) {
              document.getElementById('token').value = data.accessToken
              localStorage.setItem('jwt_token', data.accessToken)
              alert('Token retrieved successfully! Click Connect.')
            } else {
              alert('Failed to get token: ' + (data.message || 'Unknown error'))
            }
          })
          .catch((error) => {
            alert('Error: ' + error.message)
          })
      }

      function updateStatus(message, connected) {
        const statusDiv = document.getElementById('status')
        statusDiv.textContent = `Status: ${message}`
        statusDiv.className = connected
          ? 'status connected'
          : 'status disconnected'

        document.getElementById('connectBtn').disabled = connected
        document.getElementById('disconnectBtn').disabled = !connected
        document.getElementById('pingBtn').disabled = !connected
      }

      function showError(message) {
        const errorBox = document.getElementById('errorBox')
        errorBox.textContent = '‚ùå Error: ' + message
        errorBox.style.display = 'block'
      }

      function hideError() {
        document.getElementById('errorBox').style.display = 'none'
      }

      function addNotification(
        type,
        message,
        isSystem,
        timestamp,
        isError = false,
      ) {
        const list = document.getElementById('notificationsList')
        const notif = document.createElement('div')
        notif.className =
          'notification' +
          (isSystem ? '' : ' unread') +
          (isError ? ' error' : '')

        const time = timestamp
          ? new Date(timestamp).toLocaleTimeString()
          : new Date().toLocaleTimeString()

        notif.innerHTML = `
        <strong>${type}</strong> - ${time}<br>
        ${message}
      `

        list.insertBefore(notif, list.firstChild)
      }

      window.addEventListener('load', () => {
        const savedToken = localStorage.getItem('jwt_token')
        if (savedToken) {
          document.getElementById('token').value = savedToken
        }
      })

      document.getElementById('token').addEventListener('change', (e) => {
        localStorage.setItem('jwt_token', e.target.value)
      })
    </script>
  </body>
</html>
